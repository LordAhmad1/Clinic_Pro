<div class="patient-preview-page fade-in" [dir]="translationService.getDirection()">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
      <button class="btn btn-outline-light me-3" (click)="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div>
                 <h2 class="fw-bold mb-0 text-white">
           <i class="fas fa-user me-2" style="color: #D6B96A;"></i>
           {{ translationService.translate('patientDetails') }}
         </h2>
         <p class="text-white mb-0">{{ translationService.translate('viewPatientInfo') }}</p>
      </div>
    </div>
         <div class="d-flex gap-2">
       <!-- <button class="btn btn-outline-light" (click)="translationService.switchLanguage()">
         <i class="fas fa-language me-1"></i>
         {{ translationService.getCurrentLanguage() === 'en' ? 'العربية' : 'English' }}
       </button> -->
       <button class="btn btn-primary" (click)="openPrescriptionModal()">
         <i class="fas fa-prescription-bottle-medical me-2" style="color: #D6B96A;"></i>
         {{ translationService.translate('writePrescription') }}
       </button>
     </div>
  </div>

  <div *ngIf="patient" class="row">
    <!-- Patient Information -->
    <div class="col-lg-4 mb-4">
      <div class="card">
                 <div class="card-header bg-white border-0">
                       <h5 class="mb-0 fw-semibold">
              <i class="fas fa-user-circle me-2" style="color: #D6B96A;"></i>
              {{ translationService.translate('patientInformation') }}
            </h5>
         </div>
        <div class="card-body">
          <div class="text-center mb-4">
            <div class="position-relative d-inline-block">
              <div *ngIf="getPatientPhoto() && getPatientPhoto().startsWith('data:image'); else initialsAvatar" class="avatar-large">
  <img [src]="getPatientPhoto()" [alt]="patient.name" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
</div>
              <ng-template #initialsAvatar>
                <div class="avatar-large bg-primary text-white d-flex align-items-center justify-content-center rounded-circle" style="width: 120px; height: 120px; font-size: 3rem;">
                  {{ getPatientInitials() }}
                </div>
              </ng-template>
            </div>
                         <h4 class="mt-3 mb-1">{{ patient.name }}</h4>
             <p class="text-muted mb-0">{{ translationService.translate('patientId') }}: {{ patient.nationalId }}</p>
          </div>

                     <div class="row">
             <div class="col-6">
                               <div class="mb-3">
                  <label class="form-label text-muted">{{ translationService.translate('age') }}</label>
                  <p class="mb-0 fw-semibold">{{ getPatientAge() }} {{ translationService.translate('years') }}</p>
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label class="form-label text-muted">{{ translationService.translate('gender') }}</label>
                  <p class="mb-0 fw-semibold">{{ translationService.getGenderText(patient.gender) }}</p>
                </div>
              </div>
           </div>

                                 <div class="mb-3">
              <label class="form-label text-muted">{{ translationService.translate('phone') }}</label>
              <p class="mb-0 fw-semibold">{{ patient.phone }}</p>
            </div>

            <div class="mb-3">
              <label class="form-label text-muted">{{ translationService.translate('email') }}</label>
              <p class="mb-0 fw-semibold">{{ patient.email || translationService.translate('notProvided') }}</p>
            </div>

            <div class="mb-3">
              <label class="form-label text-muted">{{ translationService.translate('address') }}</label>
              <p class="mb-0 fw-semibold">{{ patient.address || translationService.translate('notProvided') }}</p>
            </div>

            <div class="mb-3">
              <label class="form-label text-muted">{{ translationService.translate('bloodType') }}</label>
              <p class="mb-0 fw-semibold">{{ patient.bloodType || translationService.translate('notSpecified') }}</p>
            </div>

            <div class="mb-3">
              <label class="form-label text-muted">{{ translationService.translate('allergies') }}</label>
              <p class="mb-0 fw-semibold">{{ patient.allergies || translationService.translate('noneKnown') }}</p>
            </div>
        </div>
      </div>

             <!-- Emergency Contact -->
       <div class="card mt-4">
                   <div class="card-header bg-white border-0">
            <h5 class="mb-0 fw-semibold">
              <i class="fas fa-phone-alt me-2" style="color: #D6B96A;"></i>
              {{ translationService.translate('emergencyContact') }}
            </h5>
          </div>
          <div class="card-body">
                       <div class="mb-3">
               <label class="form-label text-muted">{{ translationService.translate('name') }}</label>
               <p class="mb-0 fw-semibold">{{ patient.emergencyContact.name || translationService.translate('notProvided') }}</p>
             </div>
             <div class="mb-3">
               <label class="form-label text-muted">{{ translationService.translate('relationship') }}</label>
               <p class="mb-0 fw-semibold">{{ patient.emergencyContact.relationship || translationService.translate('notSpecified') }}</p>
             </div>
             <div class="mb-3">
               <label class="form-label text-muted">{{ translationService.translate('phone') }}</label>
               <p class="mb-0 fw-semibold">{{ patient.emergencyContact.phone || translationService.translate('notProvided') }}</p>
             </div>
          </div>
       </div>
    </div>

         <!-- Prescriptions -->
     <div class="col-lg-8">
       <div class="card">
         <div class="card-header bg-white border-0">
                       <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 fw-semibold">
                <i class="fas fa-prescription-bottle me-2" style="color: #D6B96A;"></i>
                {{ translationService.translate('prescriptions') }}
              </h5>
              <span class="badge bg-primary">{{ prescriptions.length }} {{ translationService.translate('prescriptionsCount') }}</span>
            </div>
          </div>
          <div class="card-body">
            <div *ngIf="prescriptions.length === 0" class="text-center py-5">
              <i class="fas fa-prescription-bottle fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">{{ translationService.translate('noPrescriptions') }}</h5>
              <p class="text-muted">{{ translationService.translate('clickToAdd') }}</p>
            </div>

          <div *ngFor="let prescription of prescriptions" class="prescription-item mb-4 p-3 border rounded">
                         <div class="d-flex justify-content-between align-items-start mb-3">
               <div>
                                   <h6 class="mb-1">{{ translationService.translate('prescription') }} #{{ prescription.id }}</h6>
                 <p class="text-muted mb-0">{{ prescription.date | date:'MMM d, y' }}</p>
               </div>
               <button class="btn btn-sm btn-outline-danger" (click)="deletePrescription(prescription.id)">
                 <i class="fas fa-trash"></i>
               </button>
             </div>

             <div class="row mb-3">
               <div class="col-md-6">
                                   <label class="form-label text-muted">{{ translationService.translate('diagnosis') }}</label>
                 <p class="mb-0 fw-semibold">{{ prescription.diagnosis }}</p>
               </div>
               <div class="col-md-6">
                                   <label class="form-label text-muted">{{ translationService.translate('prescribedBy') }}</label>
                 <p class="mb-0 fw-semibold">{{ prescription.doctorName }}</p>
               </div>
             </div>

             <div class="mb-3">
               <label class="form-label text-muted">{{ translationService.translate('medications') }}</label>
               <div class="table-responsive">
                 <table class="table table-sm">
                   <thead>
                     <tr>
                       <th>{{ translationService.translate('medication') }}</th>
                       <th>{{ translationService.translate('dosage') }}</th>
                       <th>{{ translationService.translate('frequency') }}</th>
                       <th>{{ translationService.translate('duration') }}</th>
                     </tr>
                   </thead>
                   <tbody>
                     <tr *ngFor="let medication of prescription.medications">
                       <td>{{ medication.name }}</td>
                       <td>{{ medication.dosage }}</td>
                       <td>{{ medication.frequency }}</td>
                       <td>{{ medication.duration }}</td>
                     </tr>
                   </tbody>
                 </table>
               </div>
             </div>
             
             <!-- Prescription QR Code Buttons -->
             <div class="mb-3">
               <label class="form-label text-muted">{{ translationService.translate('prescriptionQR') }}</label>
               <div class="d-flex align-items-center gap-2">
                 <!-- English QR Code Button -->
                 <button 
                   class="btn btn-sm" 
                   [class.btn-primary]="(prescription.scanCount || 0) < qrSettings.maxScanCount"
                   [class.btn-outline-secondary]="(prescription.scanCount || 0) >= qrSettings.maxScanCount"
                   [disabled]="(prescription.scanCount || 0) >= qrSettings.maxScanCount"
                   (click)="generatePrescriptionQRCode(prescription, 'en')" 
                   [title]="(prescription.scanCount || 0) >= qrSettings.maxScanCount ? translationService.translate('scanLimitReached') : translationService.translate('generateEnglishQR')">
                   <i class="fas fa-qrcode"></i>
                   <small class="ms-1">{{ translationService.translate('englishQR') }}</small>
                 </button>
                 
                 <!-- Arabic QR Code Button -->
                 <button 
                   class="btn btn-sm" 
                   [class.btn-info]="(prescription.scanCount || 0) < qrSettings.maxScanCount"
                   [class.btn-outline-secondary]="(prescription.scanCount || 0) >= qrSettings.maxScanCount"
                   [disabled]="(prescription.scanCount || 0) >= qrSettings.maxScanCount"
                   (click)="generatePrescriptionQRCode(prescription, 'ar')" 
                   [title]="(prescription.scanCount || 0) >= qrSettings.maxScanCount ? translationService.translate('scanLimitReached') : translationService.translate('generateArabicQR')">
                   <i class="fas fa-qrcode"></i>
                   <small class="ms-1">{{ translationService.translate('arabicQR') }}</small>
                 </button>
                 
                 <small class="text-muted" *ngIf="(prescription.scanCount || 0) > 0">
                   {{ prescription.scanCount }}/{{ qrSettings.maxScanCount }}
                 </small>
               </div>
             </div>

                         <div *ngIf="prescription.instructions" class="mb-3">
                               <label class="form-label text-muted">{{ translationService.translate('instructions') }}</label>
               <p class="mb-0">{{ prescription.instructions }}</p>
             </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Write Prescription Modal -->
  <div class="modal fade show d-block" *ngIf="showPrescriptionModal" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header" style="border-radius: 16px 16px 0 0; background: linear-gradient(135deg, var(--primary-color), var(--dark-red)); border: none;">
                     <h5 class="modal-title text-white">
             <i class="fas fa-prescription-bottle-medical me-2" style="color: #D6B96A;"></i>
                           {{ translationService.translate('writePrescription') }} style="color: #black;"
           </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closePrescriptionModal()" style="filter: brightness(1.2); transform: scale(1.1);"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="savePrescription()" #prescriptionForm="ngForm">
                         <div class="row">
               <div class="col-md-6 mb-3">
                                   <label for="date" class="form-label">{{ translationService.translate('date') }} *</label>
                 <input type="date" class="form-control" id="date" [(ngModel)]="newPrescription.date" name="date" required>
               </div>
               <div class="col-md-6 mb-3">
                                   <label for="doctorName" class="form-label">{{ translationService.translate('prescribedBy') }} *</label>
                 <input type="text" class="form-control" id="doctorName" [(ngModel)]="newPrescription.doctorName" name="doctorName" required>
               </div>
             </div>

             <div class="mb-3">
                               <label for="diagnosis" class="form-label">{{ translationService.translate('diagnosis') }} *</label>
               <textarea class="form-control" id="diagnosis" rows="3" [(ngModel)]="newPrescription.diagnosis" name="diagnosis" required></textarea>
             </div>

                         <!-- Medications Section -->
             <div class="card mb-3">
               <div class="card-header">
                 <h6 class="mb-0">
                   <i class="fas fa-pills me-2" style="color: #D6B96A;"></i>
                   <span style="color: black;">{{ translationService.translate('medications') }}</span>
                 </h6>
               </div>
              <div class="card-body">
                <div *ngFor="let medication of newPrescription.medications; let i = index" class="medication-item mb-3 p-3 border rounded">
                                     <div class="d-flex justify-content-between align-items-start mb-2">
                                           <h6 class="mb-0">{{ translationService.translate('medication') }} {{ i + 1 }}</h6>
                     <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeMedication(i)">
                       <i class="fas fa-times"></i>
                     </button>
                   </div>
                                      <div class="row">
                     <div class="col-md-6">
                       <label class="form-label">{{ translationService.translate('name') }}</label>
                       <p class="mb-0 fw-semibold" style="color: black;">{{ medication.name }}</p>
                     </div>
                                          <div class="col-md-6">
                       <label class="form-label">{{ translationService.translate('dosage') }}</label>
                       <p class="mb-0 fw-semibold" style="color: black;">{{ medication.dosage }}</p>
                     </div>
                   </div>
                                      <div class="row">
                     <div class="col-md-4">
                       <label class="form-label">{{ translationService.translate('frequency') }}</label>
                       <p class="mb-0 fw-semibold" style="color: black;">{{ medication.frequency }}</p>
                     </div>
                     <div class="col-md-4">
                       <label class="form-label">{{ translationService.translate('duration') }}</label>
                       <p class="mb-0 fw-semibold" style="color: black;">{{ medication.duration }}</p>
                     </div>
                     <div class="col-md-4">
                       <label class="form-label">{{ translationService.translate('instructions') }}</label>
                       <p class="mb-0 fw-semibold" style="color: black;">{{ medication.instructions }}</p>
                     </div>
                   </div>
                </div>

                                 <!-- Add Medication Form -->
                 <div class="border rounded p-3">
                                       <h6 class="mb-3">{{ translationService.translate('addNewMedication') }}</h6>
                   <div class="row">
                                          <div class="col-md-6 mb-3">
                       <label for="medName" class="form-label">{{ translationService.translate('medicationName') }} *</label>
                       <input style="color: black;" type="text" class="form-control" id="medName" [(ngModel)]="newMedication.name" name="medName" required>
                     </div>
                     <div class="col-md-6 mb-3">
                                               <label for="medDosage" class="form-label">{{ translationService.translate('dosage') }} *</label>
                       <input style="color: black;" type="text" class="form-control" id="medDosage" [(ngModel)]="newMedication.dosage" name="medDosage" [placeholder]="translationService.translate('exampleDosage')" required>
                     </div>
                   </div>
                   <div class="row">
                                          <div class="col-md-4 mb-3">
                       <label for="medFrequency" class="form-label">{{ translationService.translate('frequency') }}</label>
                       <input style="color: black;" type="text" class="form-control" id="medFrequency" [(ngModel)]="newMedication.frequency" name="medFrequency" [placeholder]="translationService.translate('exampleFrequency')">
                     </div>
                                          <div class="col-md-4 mb-3">
                       <label for="medDuration" class="form-label">{{ translationService.translate('duration') }}</label>
                       <input style="color: black;" type="text" class="form-control" id="medDuration" [(ngModel)]="newMedication.duration" name="medDuration" [placeholder]="translationService.translate('exampleDuration')">
                     </div>
                                          <div class="col-md-4 mb-3">
                       <label for="medInstructions" class="form-label">{{ translationService.translate('specialInstructions') }}</label>
                       <input style="color: black;" type="text" class="form-control" id="medInstructions" [(ngModel)]="newMedication.instructions" name="medInstructions" [placeholder]="translationService.translate('exampleInstructions')">
                     </div>
                   </div>
                   <button type="button" class="btn btn-outline-primary" (click)="addMedication()">
                                               <i class="fas fa-plus me-1"></i>{{ translationService.translate('addMedication') }}
                   </button>
                 </div>
              </div>
            </div>

                         <div class="mb-3">
                               <label for="instructions" class="form-label">{{ translationService.translate('generalInstructions') }}</label>
               <textarea class="form-control" id="instructions" rows="3" [(ngModel)]="newPrescription.instructions" name="instructions" [placeholder]="translationService.translate('additionalInstructions')"></textarea>
             </div>

             <div class="d-flex justify-content-end gap-2">
                               <button type="button" class="btn btn-secondary" (click)="closePrescriptionModal()">{{ translationService.translate('cancel') }}</button>
               <button type="submit" class="btn btn-primary" [disabled]="newPrescription.medications.length === 0 || !newPrescription.diagnosis">
                                   <i class="fas fa-save me-1"></i>{{ translationService.translate('savePrescription') }}
               </button>
             </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div class="modal fade show d-block" *ngIf="showQRModal" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="border-radius: 16px 16px 0 0; background: linear-gradient(135deg, var(--primary-color), var(--dark-red)); border: none;">
          <h5 class="modal-title text-white">
            <i class="fas fa-qrcode me-2" style="color: #D6B96A;"></i>
            {{ translationService.translate('medicationQRCode') }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeQRModal()" style="filter: brightness(1.2); transform: scale(1.1);"></button>
        </div>
        <div class="modal-body text-center" style="color: #000 !important; background: white !important;">
                     <div *ngIf="selectedMedication" class="mb-4">
             <h4 class="mb-3" style="color: #000 !important; font-weight: bold;">{{ selectedMedication.name }}</h4>
             <div class="row text-start">
               <div class="col-md-6">
                 <p style="color: #000 !important; font-weight: bold;"><strong>{{ translationService.translate('dosage') }}:</strong> {{ selectedMedication.dosage }}</p>
                 <p style="color: #000 !important; font-weight: bold;"><strong>{{ translationService.translate('frequency') }}:</strong> {{ selectedMedication.frequency }}</p>
               </div>
               <div class="col-md-6">
                 <p style="color: #000 !important; font-weight: bold;"><strong>{{ translationService.translate('duration') }}:</strong> {{ selectedMedication.duration }}</p>
                 <p style="color: #000 !important; font-weight: bold;"><strong>{{ translationService.translate('instructions') }}:</strong> {{ selectedMedication.instructions }}</p>
               </div>
             </div>
             <div class="alert alert-warning mt-3" *ngIf="(selectedMedication.scanCount || 0) > 0" style="color: #000 !important;">
               <i class="fas fa-exclamation-triangle me-2"></i>
                               <strong style="color: #000 !important;">{{ translationService.translate('scanCount') }}:</strong> {{ selectedMedication.scanCount }}/{{ qrSettings.maxScanCount }} 
                             <span *ngIf="(selectedMedication.scanCount || 0) >= qrSettings.maxScanCount" style="color: #dc3545 !important; font-weight: bold;">({{ translationService.translate('limitReached') }})</span>
              <span *ngIf="(selectedMedication.scanCount || 0) < qrSettings.maxScanCount" style="color: #198754 !important; font-weight: bold;">({{ qrSettings.maxScanCount - (selectedMedication.scanCount || 0) }} {{ translationService.translate('scansRemaining') }})</span>
             </div>
           </div>
          
          <div class="qr-code-container mb-4">
            <img *ngIf="qrCodeDataUrl" [src]="qrCodeDataUrl" alt="Medication QR Code" class="img-fluid" style="max-width: 300px;">
            <div *ngIf="!qrCodeDataUrl" style="color: #000 !important; font-weight: bold;">
              <i class="fas fa-spinner fa-spin fa-2x mb-2" style="color: #000 !important;"></i>
              <p style="color: #000 !important; font-weight: bold;">{{ translationService.translate('generatingQRCode') }}</p>
            </div>
          </div>
          
          <div class="alert alert-info" style="color: #000 !important; background: #d1ecf1 !important; border-color: #bee5eb !important;">
            <i class="fas fa-info-circle me-1" style="color: #000 !important;"></i>
            <span style="color: #000 !important; font-weight: bold;">{{ translationService.translate('qrCodeInfo') }}</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeQRModal()">
            <i class="fas fa-times me-1"></i>{{ translationService.translate('close') }}
          </button>
          <button type="button" class="btn btn-outline-primary" (click)="downloadQRCode()" [disabled]="!qrCodeDataUrl">
            <i class="fas fa-download me-1"></i>{{ translationService.translate('download') }}
          </button>
          <button type="button" class="btn btn-primary" (click)="printQRCode()" [disabled]="!qrCodeDataUrl">
            <i class="fas fa-print me-1"></i>{{ translationService.translate('print') }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div> 